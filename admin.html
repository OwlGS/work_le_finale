<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора - Корочки.есть</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/mobile.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="container">
                <a href="index.html" class="logo">
                    <img src="images/logo.svg" alt="Корочки.есть" style="height: 40px;">
                </a>
                <div class="nav-links">
                    <a href="admin.html">Все заявки</a>
                    <a href="#" onclick="AuthService.logout(); return false;">Выход</a>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="container" style="margin-top: 2rem;">
            <h1 class="text-center">Все заявки пользователей</h1>
            
            <!-- Фильтры -->
            <div style="margin: 2rem 0; display: flex; gap: 1rem; flex-wrap: wrap;">
                <select id="statusFilter" style="padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                    <option value="all">Все статусы</option>
                    <option value="new">Новые</option>
                    <option value="in_progress">Идет обучение</option>
                    <option value="completed">Завершено</option>
                </select>
                <input type="text" id="searchInput" placeholder="Поиск по имени или email" style="padding: 10px; border-radius: 5px; border: 1px solid #ddd; flex: 1;">
            </div>

            <div id="applicationsContainer">
                <div class="loader"></div>
            </div>
        </div>
    </main>

    <script src="scripts/auth.js"></script>
    <script>
        let allApplications = [];

        const user = AuthService.getUser();
        if (!user || user.role !== 'admin') {
            alert('Доступ запрещен');
            window.location.href = 'index.html';
        }

        async function loadApplications() {
            try {
                const response = await fetch(`${API_URL}/applications/all`, {
                    headers: AuthService.getAuthHeaders()
                });

                if (response.ok) {
                    allApplications = await response.json();
                    displayApplications(allApplications);
                } else {
                    alert('Ошибка загрузки заявок');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка соединения с сервером');
            }
        }

        function displayApplications(applications) {
            const container = document.getElementById('applicationsContainer');
            
            if (applications.length === 0) {
                container.innerHTML = '<p class="text-center">Заявок не найдено</p>';
                return;
            }

            const statusText = {
                'new': 'Новая',
                'in_progress': 'Идет обучение',
                'completed': 'Завершено'
            };

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Пользователь</th>
                            <th>Email</th>
                            <th>Телефон</th>
                            <th>Курс</th>
                            <th>Дата начала</th>
                            <th>Оплата</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            applications.forEach(app => {
                const statusClass = `status-${app.status}`;
                
                html += `
                    <tr class="fade-in">
                        <td>${app.application_id}</td>
                        <td>${app.user_name}</td>
                        <td>${app.user_email}</td>
                        <td>${app.user_phone}</td>
                        <td>${app.course_name}</td>
                        <td>${app.start_date}</td>
                        <td>${app.payment_method === 'cash' ? 'Наличными' : 'Перевод'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText[app.status]}</span></td>
                        <td>
                            <select onchange="updateStatus(${app.application_id}, this.value)" style="padding: 5px;">
                                <option value="">Изменить статус</option>
                                <option value="new" ${app.status === 'new' ? 'disabled' : ''}>Новая</option>
                                <option value="in_progress" ${app.status === 'in_progress' ? 'disabled' : ''}>Идет обучение</option>
                                <option value="completed" ${app.status === 'completed' ? 'disabled' : ''}>Завершено</option>
                            </select>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function updateStatus(applicationId, newStatus) {
            if (!newStatus) return;

            if (!confirm('Изменить статус заявки?')) return;

            try {
                const response = await fetch(`${API_URL}/applications/${applicationId}/status`, {
                    method: 'PATCH',
                    headers: AuthService.getAuthHeaders(),
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    alert('Статус успешно обновлен');
                    loadApplications();
                } else {
                    const data = await response.json();
                    alert('Ошибка: ' + data.error);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка соединения с сервером');
            }
        }

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            const status = e.target.value;
            const filtered = status === 'all' ? 
                allApplications : 
                allApplications.filter(app => app.status === status);
            displayApplications(filtered);
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            const filtered = allApplications.filter(app => 
                app.user_name.toLowerCase().includes(search) ||
                app.user_email.toLowerCase().includes(search)
            );
            displayApplications(filtered);
        });

        loadApplications();
    </script>
</body>
</html>

